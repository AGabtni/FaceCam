<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>FaceCam</title>
        <meta name="description" content="More info">
        <meta name="keywords" content="More info">
        {% load staticfiles %}
        {% load static %}
        <link rel="shortcut icon" type="image/x-icon" href="../../static/assets">
        <link rel="shortcut icon" type="image/x-icon" href="../../static/assets">
        <link rel="alternate" href="/facecam_livestream_page.html" hreflang="en" />
        <link rel="alternate" href="../fr/facecam_livestream_page.html" hreflang="fr" />
        <link rel="alternate" href="/facecam_livestream_page.html" hreflang="x-default" />
        <link type="text/css" rel="stylesheet" href="../../static/css/normalize-7.0.0.css"/>
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/Widget/css/Widget.css?v=1.0.24"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/Header/css/Header.css?v=1.0.77-beta"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/Text/css/Text.css?v=1.0.2"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/NavigationItem/css/NavigationItem.css?v=1.0.1"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/Main/css/Main.css?v=1.0.4-beta"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/Section/css/Section.css?v=1.0.33-beta"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/_global/Title/css/Title.css?v=1.0.110-beta"/>
        <link type="text/css" rel="stylesheet" href="../../static/widgets/member2/Footer/css/Footer.css?v=1.0.16-beta"/>
        <link rel="stylesheet" type="text/css" href="../../static/css/pages/page-3.css?v=1549135301">
    </head>
    <body id="page-3" pageId="" class="Widget Page" role="page">

        <header id="Header2" class="Widget Header" role="">
            <a href="{% url 'index' %}" id="member2__Image2" class="Widget member2__Image" role=""><img src="../../static/assets/cctv.png"></img></a>
            <nav class="Widget Navbar navbar navbar-toggleable-md navbar-light bg-faded" id="Navbar2" role="navigation navbar">
                <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#Navbar2Responsive" aria-controls="Navbar2Responsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-brand">
                    <div id="Text16" class="Widget Text" role=""><a href="{% url 'index' %}"></a><span>FaceCam</span></div>
                </div>
                <div class="collapse navbar-collapse justify-content-between" id="Navbar2Responsive">
                    {% if user.is_authenticated %}
                        <ul class="Widget Navigation navbar-nav nav" id="Navigation3" role="navigation">
                            <li class="Widget NavigationItem nav-item nav-link" id="NavigationItem7" role="menuitem"> <a href="#" >{{ user.get_username }}</a> </li>
                            <li class="Widget NavigationItem nav-item nav-link" id="NavigationItem8" role="menuitem"> <a href="#" >FaceCam LiveStream</a> </li>
                            <li class="Widget NavigationItem nav-item nav-link" id="NavigationItem9" role="menuitem"> <a href="#" >Documentations</a> </li>
                            <li class="Widget NavigationItem nav-item nav-link" id="NavigationItem10" role="menuitem"> <a href="#" >Contact</a> </li>
                            <li  style="color:white;" class="Widget NavigationItem nav-item nav-link" id="NavigationItem11" role="menuitem">
                                <a href="{% url 'logout'%}" >Log Out</a>
                            </li>
                        </ul>
                    {% else %}
                        <li style="color:white;" class="Widget NavigationItem nav-item nav-link" id="NavigationItem72" role="menuitem">
                            <a href="{% url 'login'%}?next={{request.path}}" >Login</a>
                        </li>
                    {% endif %}
                </div>
            </nav>
        </header>
        <style>
            .visitorCanvas{
                height: 192px;
                width: 256px ;
                outline: midnightblue 3px solid;
            }
             .visitor_header{
                 text-align: center
             }
             #overlayUI{

                 position: absolute; /* Hidden by default */
                 width: 256px; /* Full width (cover the whole page) */
                 height: 192px; /* Full height (cover the whole page) */
                 z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
                 cursor: pointer; /* Add a pointer on hover */
             }
             #overlay-canvas{
                 position: absolute;
                 z-index: 2;
             }
             .removebtn{
                position: absolute;

             }

            .updateVisitor{
                position: absolute;
                margin-left: 73.75%;
            }
            .parent {
              position: relative;
              width: 100%;
              height: 100%;

            }
            .previous, .next {
                position: absolute;
                top: 0;
                bottom: 0;
                margin: auto;
            }
            .previous {
                left: 0;
                margin-left: 15px;
            }
            .next {
                right: 0;
                padding-top: 17%;
                margin-right: 15px;
            }

            .aParent div {
                float: left;
                clear: none;
            }
             table{
                 align-content: center;
             }
            td{
                padding-right: 10px;
             }
            tr.spaceUnder>td {
                padding-bottom: 1em;
            }

            .rightRotate{

                margin-left: 700px;

            }
            .rightRotate.p{
                margin-left: -50px;
                position: center ;
            }
            .sliderForm[type=range][orient=vertical]
            {
                writing-mode: bt-lr; /* IE */
                -webkit-appearance: slider-vertical; /* WebKit */
                width: 8px;
                height: 175px;
                padding: 0 5px;

            }
            .slider {
              width: 175px;
            }
            .stream{

                margin-bottom: 0px;
            }
            #rotateLeftRight{

                margin-bottom: 25px;
            }
        </style>
        <main id="Main8" class="Widget Main" role="">
            <div id="Container19" class="Widget Container" role="">
                <section id="Section31" class="Widget Section" role="">
                    <h1 id="Title19" class="Widget Title" role="">
                        <p>FaceCam Live Stream&nbsp;</p>
                    </h1>
                </section>
                <div id = "Container20" class="parent">
                    <div id = "Container21" class="previous" id="container">
                        <div>
                            <form  method ="post">
                                <p>Position(Left or right):
                                    <span id="servoPos"></span>
                                </p>
                                {% csrf_token %}

                                <input type="range" name = "horizontal" min="0" max="180" class="slider" id="servoSlider" onchange="servo(this.value)"/>
                                <button id="rotateLeftRight" type="submit"  value="Rotate" onclick="sending();" >Rotate</button>

                            </form>
                        </div>
                        <div class="stream" style="position: relative;">
                            <canvas id="overlay-canvas" width="100" height="100" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
                            <canvas id="video-canvas" width="100" height="100" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
                        </div>

  				    </div>
                    <div class="rightRotate">
                            <p class="rightRotate p">Position(up or down):
                                <span id="servoPos2"></span>
                            </p>
                            <form method="post">
                                {% csrf_token %}
                                <input type="range" name="vectival" min="0" max="180" orient="vertical" class="sliderForm" id="servoSlider2" onchange="servo2(this.value)"/><br/>

                            </form>

                        </div>

                    <div id = "Container22" class="next">

                        <table>
                            <tr>
                                <th class="visitor_header" id="v_1">Visitor 1</th>
                                <th class="visitor_header" id="v_2"></th>
                                <th class="visitor_header"  id="v_3"></th>
                            </tr>
                            <tr>

                                <td>
                                    <!--
                                    <input  type="hidden" id="canvasData" name="canvasData"/>
                                    <input type='button' value="update" onclick='updateData();'>-->

                                     <div id = "overlayUI">
                                         <input class = "removebtn" id="Rmv1" width="20" height="20" type='button' value="x" onclick='clearVisitor("visitor1",0);'>

                                         <form action="{% url 'add_visitor' %}" method="POST" id="post-form">
                                             <div id="results"></div>
                                             {% csrf_token %}
                                             <button type="submit" class="updateVisitor">Update</button>
                                         </form>

                                     </div>
                                    <canvas class="visitorCanvas" id="visitor1">

                                    </canvas>
                                    <script type="text/javascript">
                                        function updateData() {
                                        $('#canvasData')[0].value = $('canvas')[0].toDataURL();}
                                    </script>

                                </td>
                                <td>
                                    <div id = "overlayUI">
                                        <input class = "removebtn" id="Rmv2"  type='button' value="x" onclick='clearVisitor("visitor2",1);'>

                                    </div>
                                    <canvas class="visitorCanvas" id="visitor2"></canvas>
                                </td>

                                <td>
                                    <div id="overlayUI">
                                        <input class = "removebtn" id="Rmv3" width="20" height="20" type='button' value="x" onclick='clearVisitor("visitor3",2);'>
                                    </div>
                                    <canvas class="visitorCanvas" id="visitor3"></canvas>
                                </td>
                            </tr>
                            <tr class ="spaceUnder">
                                <th class="visitor_header" id="v_4"></th>
                                <th class="visitor_header" id="v_5"></th>
                                <th class="visitor_header" id="v_6"></th>
                            </tr>
                            <tr >
                                <td>
                                    <div id="overlayUI">
                                        <input id="Rmv4" width="20" height="20" type='button' value="x"  onclick='clearVisitor("visitor4",3);'>
                                    </div>
                                    <canvas class="visitorCanvas" id="visitor4"></canvas>
                                </td>
                                <td>
                                    <div id="overlayUI">
                                        <input id="Rmv5" width="20" height="20" type='button' value="x"  onclick='clearVisitor("visitor5",4);'>
                                    </div>
                                    <canvas class="visitorCanvas" id="visitor5"></canvas>
                                </td>
                                <td>
                                    <div id="overlayUI">
                                        <input id="Rmv6" width="20" height="20" type='button' value="x" onclick='clearVisitor("visitor6",5);'>
                                    </div>
                                    <canvas class="visitorCanvas" id="visitor6"></canvas>
                                </td>

                            </tr>
                        </table>

  				     </div>
                </div>



            </div>
            <div id="Container20" class="Widget Container" role=""></div>
            <div id="Container21" class="Widget Container" role=""></div>
            <div id="Container22" class="Widget Container" role=""></div>
        </main>
        <footer style= "bottom: 0" id="member2__Footer2" class="Widget member2__Footer" role="">
            <div id="Container12" class="Widget Container" role="">
                <section id="Section18" class="Widget Section" role="">
                    <div id="Text23" class="Widget Text" role="">
                    <section id="Section19" class="Widget Section" role="">

                    </section>
                </section>
            </div>
        </footer>
    </body>
    {% load staticfiles %}
    {% load static %}
    <script type="text/javascript" src="{% static  'js/jsmpeg.min.js'%}"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Widget/js/Widget.js?v=1.0.24"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Header/js/Header.js?v=1.0.77-beta"></script>
    <script type="text/javascript" src="../../static/widgets/member2/Image/js/Image.js?v=1.0.34-beta"></script>
    <script type="text/javascript" src="../../static/widgets/_global/NavigationItem/js/navigationItem.js?v=1.0.1"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Main/js/Main.js?v=1.0.4-beta"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Container/js/Container.js?v=1.0.1"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Section/js/Section.js?v=1.0.33-beta"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Title/js/Title.js?v=1.0.110-beta"></script>
    <script type="text/javascript" src="../../static/widgets/member2/Footer/js/Footer.js?v=1.0.16-beta"></script>
    <script type="text/javascript" src="../../static/widgets/_global/Image/js/Image.js?v=1.0.42-beta"></script>
    {% load static %}
    <script src="{% static 'js/face-api.js' %}"></script>

    <script type="text/javascript">
        // Submit post on submit
        $('#post-form').on('submit', function(event){
                event.preventDefault();
                console.log("form submitted!");
                create_post();

        });


        function create_post() {
            console.log("create post is working!") // sanity check
            $.ajax({
                url : {% url 'add_visitor' %}, // the endpoint
                type : "POST", // http method
                data : {

                    name : $('#v_1').val(),
                    frame : $('#v_2').val(),
                    visit_date : new Date().getTime(),


                }, // data sent with the post request

                // handle a successful response
                success : function(json) {
                    $('#v_1').val(''); // remove the value from the input
                    console.log(json); // log the returned json to the console
                    console.log("success"); // another sanity check
                },

                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            });
        };
    </script>
    <script type="text/javascript">
    var slider = document.getElementById("servoSlider");
    var servoP = document.getElementById("servoPos");
	var slider2 = document.getElementById("servoSlider2");
    var servoP2 = document.getElementById("servoPos2");
    servoP.innerHTML = slider.value;
	servoP2.innerHTML = slider2.value;
    slider.oninput = function() {
      slider.value = this.value;
      servoP.innerHTML = this.value;
    }
	slider2.oninput = function() {

      slider2.value = this.value;
      servoP2.innerHTML = this.value;
    }
	var url = 'ws://172.20.10.5:5000';
	var mySocket = new WebSocket(url);

	mySocket.onopen = function () {
		console.log('opened !');
		//container.innerHTML += '<h2>Connection established : ' + url + '</h2>';
	};

	mySocket.onmessage = function (e) {
		console.log('server: ' + e.data);
		//container.innerHTML += '<div><span>Server: </span><span>' + e.data + '</span></div>';
	};

	mySocket.onclose = function () {
		console.log('closed !');
		//container.innerHTML += '<h2>Connection closed</h2>';
	};
	function sending(){

		mySocket.send(slider.value);
		mySocket.send(slider2.value);

	}

	/*
    $.ajaxSetup({timeout:1000});
    function servo(pos) {
      $.get("/?value=" + pos + "&");
      {Connection: close};
    }
	function servo2(pos) {
      $.get("/?value=" + pos + "&");
      {Connection: close};
    }*/
  </script>
    <script type="text/javascript">

        var canvas = document.getElementById('video-canvas');
		var url = 'ws://45.61.49.21:8082/';
		var player = new JSMpeg.Player(url, {canvas: canvas, disableGl: true});
		startVideoProcessing();


		let videoWidth = 640;
		let videoHeight = 480;



		let visitorsNames = [];
		let visitorsDescriptors = [];
        let visitorsCount = 0;
        const labels = ['Ahmed_Gabtni' ,'Colombe_Shellariel', 'Jose_Carreras'];

        const overlayCanvas = document.getElementById("overlay-canvas");
        const videoCanvas = document.getElementById("video-canvas");
        var currentVisitorIndex = 0;
        function clearVisitor(visitor,index) {
            currentVisitorIndex = index;
            console.log("cleaning");
            canvas = document.getElementById(visitor);
            const context = canvas.getContext('2d');
            let title = document.getElementById("v_"+(index+1));
            //hardcoded values
            context.clearRect(0,0,193*3.35,218*2.2);
            title.innerHTML = "";

            removeVisitor(index);
        }
        function removeVisitor(index){
            if(visitorsNames.length > 0 ){
                console.log("removing number "+index);
                visitorsNames.splice(index,index+1);

                visitorsCount -=1;
            }

        }

		function startVideoProcessing(){

		  //New code :
            loadModels();

		}

		let  labeledFaceDescriptors;
        let faceMatcher;
        let fullFaceDescriptions;
        let detectionsArray;


        async function loadModels() {
            await faceapi.loadSsdMobilenetv1Model("{% static 'models' %}")
            await faceapi.loadFaceLandmarkModel("{% static 'models' %}");
            await faceapi.loadFaceRecognitionModel("{% static 'models' %}");

            alert("Done loading facerecognition models now encoding dataset ..");
            //const labeledDescriptors = await encode();
            //alert("Descriptions + labels aquired from dataset");

            //const FaceMatcher = await encode();
            const overlayCanvas = document.getElementById("overlay-canvas");
            overlayCanvas.width = document.getElementById("video-canvas").width;
            overlayCanvas.height = document.getElementById("video-canvas").height;
            if(labeledFaceDescriptors == null){
                    labeledFaceDescriptors= await Promise.all(
                        labels.map(async label => {
                                // fetch image data from urls and convert blob to HTMLImage element
                                const staticUrl = "{% static 'dataset' %}";
                                const labelUrl ='/'+label+'.png';
                                const imgUrl =staticUrl+labelUrl;

                                const img = await faceapi.fetchImage(imgUrl);

                                // detect the face with the highest score in the image and compute it's landmarks and face descriptor
                                const fullFaceDescription = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                                    //.withFaceLandmarks().withFaceDescriptor()

                                if (!fullFaceDescription) {
                                  throw new Error('no faces detected for '+label);
                                }else{
                                    console.log("Encoding for : "+label);
                                }
                                const faceDescriptors = [fullFaceDescription.descriptor];

                                return new faceapi.LabeledFaceDescriptors(label, faceDescriptors);
                            })
                    );


                }
            if (faceMatcher == null){
                    const maxDescriptorDistance = 0.6;
                    faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, maxDescriptorDistance);

                }
            alert("Finished encoding the dataset now starting recognition from incoming stream ..");

            await detection();
		    await recogniton();

        }

        async function detection(){



            overlayCanvas.width = videoCanvas.width;
            overlayCanvas.height = videoCanvas.height;

            fullFaceDescriptions = await faceapi.detectAllFaces(videoCanvas).withFaceLandmarks().withFaceDescriptors();
            detectionsArray = fullFaceDescriptions.map(fd => fd.detection);

            faceapi.drawDetection(overlayCanvas, detectionsArray);
            setTimeout(() => detection());

        }

        async function recogniton() {

            if(fullFaceDescriptions.length > 0){


                const results = fullFaceDescriptions.map(fd=> faceMatcher.findBestMatch(fd.descriptor));

                if(results.length > 0){
                        var name = "Unknown";
                        const boxesWithText = results.map((bestMatch, i) => {
                            const box = fullFaceDescriptions[i].detection.box;
                            const text = bestMatch.toString();
                            var newText = text.substring(0,text.length-7);
                            name = newText;
                            const boxWithText = new faceapi.BoxWithText(box, text);
                            return boxWithText;
                        });
                        faceapi.drawDetection(overlayCanvas, boxesWithText);
                        if( visitorsCount<6 ){

                            canvasVisitor = document.getElementById('visitor'+(currentVisitorIndex+1));

                            canvasVisitorCtx = canvasVisitor.getContext('2d');
                            if(visitorsCount > 0 )
                            {
                                const descriptorRef = await faceapi.computeFaceDescriptor(videoCanvas);

                                for(var i=0; i< visitorsCount;i++){


                                    const distance = faceapi.euclideanDistance(descriptorRef,visitorsDescriptors[i]);

                                    if(distance<0.45){
                                        console.log("Already Here");
                                        console.log(distance);
                                        break;
                                    }
                                    else {
                                        console.log('Added visitor new ');
                                        visitorsNames[currentVisitorIndex]= name;
                                        visitorsDescriptors[currentVisitorIndex]= descriptorRef;
                                        drawVisitor(canvasVisitorCtx);
                                        document.getElementById("v_"+(currentVisitorIndex+1)).innerHTML = name ;
                                        visitorsCount +=1;
                                        currentVisitorIndex +=1;
                                        break;
                                    }
                                }
                            }
                            else{
                                const descriptor1 = await faceapi.computeFaceDescriptor(videoCanvas);
                                visitorsNames[currentVisitorIndex]= name;
                                visitorsDescriptors[currentVisitorIndex]= descriptor1;
                                drawVisitor(canvasVisitorCtx);
                                document.getElementById("v_"+(currentVisitorIndex+1)).innerHTML = name ;
                                visitorsCount +=1;
                                currentVisitorIndex +=1;

                            }






                        }


                }
                else if( results.length <= 0 ){

                    if( visitorsCount<6 ){

                            canvasVisitor = document.getElementById('visitor'+(currentVisitorIndex+1));

                            canvasVisitorCtx = canvasVisitor.getContext('2d');
                            if(visitorsCount > 0 )
                            {
                                const descriptorRef = await faceapi.computeFaceDescriptor(videoCanvas);

                                for(var i=0; i< visitorsCount;i++){


                                    const distance = faceapi.euclideanDistance(descriptorRef,visitorsDescriptors[i]);

                                    if(distance<0.62){
                                        console.log("Already Here");
                                        console.log(distance);
                                        break;
                                    }
                                    else {
                                        console.log('Added visitor new ');
                                        visitorsNames[currentVisitorIndex]= name;
                                        visitorsDescriptors[currentVisitorIndex]= descriptorRef;
                                        drawVisitor(canvasVisitorCtx);
                                        document.getElementById("v_"+(currentVisitorIndex+1)).innerHTML = name ;
                                        visitorsCount +=1;
                                        currentVisitorIndex +=1;
                                        break;
                                    }
                                }
                            }
                            else{
                                const descriptor1 = await faceapi.computeFaceDescriptor(videoCanvas);
                                visitorsNames[currentVisitorIndex]= name;
                                visitorsDescriptors[currentVisitorIndex]= descriptor1;
                                drawVisitor(canvasVisitorCtx);
                                document.getElementById("v_"+(currentVisitorIndex+1)).innerHTML = name ;
                                visitorsCount +=1;
                                currentVisitorIndex +=1;

                            }






                        }

                }

            }

            setTimeout(() => recogniton());

        }


        function timeout(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


		async function drawVisitor(ctx) {
            ctx.canvas.width = 640*0.4;
            ctx.canvas.height = 480*0.4;
            canvasVideoCtx = document.getElementById('video-canvas').getContext('2d');
            frameData = canvasVideoCtx.getImageData(0, 0, videoWidth, videoHeight)
            var newCanvas = $("<canvas>")
                    .attr("width", frameData.width)
                    .attr("height", frameData.height)[0];
            newCanvas.getContext("2d").putImageData(frameData, 0, 0);
            ctx.scale(ctx.canvas.width/640,ctx.canvas.width/480)
            ctx.drawImage(newCanvas,0,0);
            await timeout(3000);

        }




	</script>
    <script type="text/javascript">
    </script>
</html>
